// SKU Funnel Goals Types
// –°–∏—Å—Ç–µ–º–∞ —Ü–µ–ª–µ–π –ø–æ –≤–æ—Ä–æ–Ω–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞

import { Category } from '@/lib/auth-types';
import { GoalPeriod } from '@/types/goal-types';

// –ö–ª–∞—Å—Å SKU –ø–æ –≤—ã—Ä—É—á–∫–µ
export type SKUClass = 'gold' | 'silver' | 'bronze' | 'new';

// –ù–∞–∑–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è UI
export const SKU_CLASS_LABELS: Record<SKUClass, string> = {
    gold: 'ü•á Gold',
    silver: 'ü•à Silver',
    bronze: 'ü•â Bronze',
    new: 'üÜï New',
};

// –¶–≤–µ—Ç–∞ –¥–ª—è UI
export const SKU_CLASS_COLORS: Record<SKUClass, { bg: string; text: string; border: string }> = {
    gold: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/50' },
    silver: { bg: 'bg-slate-400/20', text: 'text-slate-300', border: 'border-slate-400/50' },
    bronze: { bg: 'bg-orange-600/20', text: 'text-orange-400', border: 'border-orange-500/50' },
    new: { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/50' },
};

// –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º (default, –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ category.yaml)
export const DEFAULT_CLASS_BENCHMARKS: Record<SKUClass, {
    ctr: number;
    crCart: number;
    crOrder: number;
}> = {
    gold: { ctr: 8, crCart: 55, crOrder: 75 },
    silver: { ctr: 6, crCart: 45, crOrder: 65 },
    bronze: { ctr: 4, crCart: 35, crOrder: 55 },
    new: { ctr: 5, crCart: 40, crOrder: 60 }, // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ü–µ–ª–∏ –¥–ª—è –Ω–æ–≤–∏–Ω–æ–∫
};

// –¶–µ–ª–∏ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ SKU
export interface SKUFunnelGoal {
    id?: string;          // UUID –∏–∑ Supabase
    nmId: number;
    sku: string;
    title?: string;
    categoryId: Category;
    skuClass: SKUClass;

    // –¶–µ–ª–∏ (%)
    targetCTR: number;        // % –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É –æ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    targetCRCart: number;     // % –∑–∞–∫–∞–∑–æ–≤ –æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω—É
    targetCROrder: number;    // % –≤—ã–∫—É–ø–æ–≤ –æ—Ç –∑–∞–∫–∞–∑–æ–≤
    targetRevenue?: number;   // ‚ÇΩ –≤ –º–µ—Å—è—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    // –ü–µ—Ä–∏–æ–¥
    period: GoalPeriod;

    // –ú–µ—Ç–∞
    isAutoGenerated: boolean;
    createdAt?: string;
    updatedAt?: string;
}

// –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–ª–µ–π SKU
export interface SKUGoalProgress {
    nmId: number;
    sku: string;
    title: string;
    categoryId: Category;
    skuClass: SKUClass;

    // –¶–µ–ª–∏
    targetCTR: number;
    targetCRCart: number;
    targetCROrder: number;
    targetRevenue?: number;

    // –§–∞–∫—Ç
    actualCTR: number;
    actualCRCart: number;
    actualCROrder: number;
    actualRevenue: number;

    // –ü—Ä–æ–≥—Ä–µ—Å—Å (%)
    ctrProgress: number;      // actualCTR / targetCTR * 100
    crCartProgress: number;
    crOrderProgress: number;
    revenueProgress?: number;

    // –°—Ç–∞—Ç—É—Å
    status: 'exceeds' | 'on_track' | 'at_risk' | 'behind';
    issueCount: number;       // –°–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫ –Ω–∏–∂–µ —Ü–µ–ª–∏
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ SKU
export interface SKUClassification {
    nmId: number;
    sku: string;
    skuClass: SKUClass;
    revenue30d: number;
    percentile: number;       // 0-100, –ø–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –≤—ã—Ä—É—á–∫–∏
}

// –ó–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π
export interface BulkGoalsUpdate {
    nmIds: number[];
    goals: Partial<Pick<SKUFunnelGoal, 'targetCTR' | 'targetCRCart' | 'targetCROrder' | 'targetRevenue'>>;
    period: GoalPeriod;
}

// –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ü–µ–ª–µ–π
export interface SKUGoalsFilter {
    categoryId?: Category;
    skuClass?: SKUClass;
    status?: 'exceeds' | 'on_track' | 'at_risk' | 'behind';
    search?: string;
    period: GoalPeriod;
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–µ–ª—è–º
export interface SKUGoalsStats {
    total: number;
    byClass: Record<SKUClass, number>;
    byStatus: {
        exceeds: number;
        onTrack: number;
        atRisk: number;
        behind: number;
    };
    avgProgress: {
        ctr: number;
        crCart: number;
        crOrder: number;
    };
}

// –£—Ç–∏–ª–∏—Ç—ã

// –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
export function calculateGoalStatus(progress: number): 'exceeds' | 'on_track' | 'at_risk' | 'behind' {
    if (progress >= 100) return 'exceeds';
    if (progress >= 80) return 'on_track';
    if (progress >= 50) return 'at_risk';
    return 'behind';
}

// –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å SKU –ø–æ –≤—Å–µ–º –º–µ—Ç—Ä–∏–∫–∞–º
export function getSKUOverallStatus(
    ctrProgress: number,
    crCartProgress: number,
    crOrderProgress: number
): { status: 'exceeds' | 'on_track' | 'at_risk' | 'behind'; issueCount: number } {
    const progressValues = [ctrProgress, crCartProgress, crOrderProgress];
    const issueCount = progressValues.filter(p => p < 80).length;

    if (issueCount === 0 && progressValues.every(p => p >= 100)) {
        return { status: 'exceeds', issueCount: 0 };
    }
    if (issueCount === 0) {
        return { status: 'on_track', issueCount: 0 };
    }
    if (issueCount <= 1) {
        return { status: 'at_risk', issueCount };
    }
    return { status: 'behind', issueCount };
}

// –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
export const GOAL_STATUS_STYLES: Record<string, { bg: string; text: string; icon: string }> = {
    exceeds: { bg: 'bg-green-500/20', text: 'text-green-400', icon: 'üöÄ' },
    on_track: { bg: 'bg-blue-500/20', text: 'text-blue-400', icon: '‚úì' },
    at_risk: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', icon: '‚ö†Ô∏è' },
    behind: { bg: 'bg-red-500/20', text: 'text-red-400', icon: '‚ùå' },
};
